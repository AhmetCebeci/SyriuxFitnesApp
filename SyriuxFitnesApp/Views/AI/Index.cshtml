
@model SyriuxFitnesApp.Models.AppUser
@{
	ViewData["Title"] = "AI Smart Trainer";
}

<div class="container py-5">
	<div class="text-center mb-5">
		<h1 class="display-4 fw-bold text-primary">Syriux AI <span class="text-dark">Smart Trainer</span></h1>
		<p class="lead text-muted">Vücut analizi ve yapay zeka destekli gelişim simülasyonu.</p>
	</div>

	<div class="row">
		<div class="col-md-4 mb-4">
			<div class="card shadow-sm border-0 h-100">
				<div class="card-header bg-dark text-white text-center py-3">
					<h5 class="mb-0"><i class="bi bi-person-bounding-box"></i> Profil</h5>
				</div>
				<div class="card-body">
					<ul class="list-group list-group-flush mb-3">
						<li class="list-group-item"><strong>Ad:</strong> @Model.FirstName @Model.LastName</li>
						<li class="list-group-item"><strong>Boy/Kilo:</strong> @Model.Height cm / @Model.Weight kg</li>
						<li class="list-group-item"><strong>Hedef:</strong> @Model.FitnessGoal</li>
					</ul>

					<div class="mb-3">
						<label class="form-label fw-bold text-danger">* Fotoğrafınız (Zorunlu)</label>
						<input type="file" id="userPhotoInput" class="form-control" accept="image/*">
						<small class="text-muted">Analiz ve simülasyon için gereklidir.</small>
					</div>
				</div>
			</div>
		</div>

		<div class="col-md-8">
			<div class="row g-3">
				<div class="col-md-6">
					<button onclick="askAI('workout', this)" class="btn btn-outline-primary w-100 p-4 h-100 shadow-sm action-btn">
						<i class="bi bi-activity fs-1 d-block mb-2"></i>
						<span class="fw-bold fs-5">Antrenman + Simülasyon</span>
						<br><small>6 Ay Sonraki Haliniz</small>
					</button>
				</div>
				<div class="col-md-6">
					<button onclick="askAI('diet', this)" class="btn btn-outline-success w-100 p-4 h-100 shadow-sm action-btn">
						<i class="bi bi-apple fs-1 d-block mb-2"></i>
						<span class="fw-bold fs-5">Diyet + Simülasyon</span>
						<br><small>2 Ay Sonraki Haliniz</small>
					</button>
				</div>
			</div>

			<div class="card mt-4 border-0 shadow" id="resultCard" style="display:none;">
				<div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
					<h5 class="mb-0">Yapay Zeka Analizi</h5>
					<button class="btn btn-sm btn-light text-primary" onclick="printDiv()">Yazdır</button>
				</div>
				<div class="card-body bg-light">

					<div id="loadingArea" class="text-center py-5">
						<div class="spinner-border text-primary" role="status"></div>
						<p class="mt-2">Fotoğraf işleniyor ve program hazırlanıyor...</p>
					</div>

					<div id="debugErrorArea" class="alert alert-warning" style="display:none;">
						<strong>HATA DETAYI (Test Amaçlı):</strong> <span id="debugErrorText"></span>
					</div>

					<div id="aiContentArea" style="display:none;">
						<div class="row">
							<div class="col-md-7 mb-3" id="aiText"></div>

							<div class="col-md-5 text-center">
								<div class="card shadow-sm p-2">
									<h6 class="text-success fw-bold mt-2" id="simTitle">Hedeflenen Görünüm</h6>
									<hr class="my-1">
									<img id="generatedImage" src="" class="img-fluid rounded" style="display:none;" />
									<div id="imagePlaceholder" class="text-muted small py-4">
										<div class="spinner-border spinner-border-sm" role="status"></div>
										<p class="mt-2">Görsel oluşturuluyor...</p>
									</div>
								</div>
							</div>
						</div>
					</div>

				</div>
			</div>
		</div>
	</div>
</div>

@section Scripts {
	<script>
		function askAI(type, btnElement) {
			// 1. Dosya Kontrolü
			var fileInput = document.getElementById('userPhotoInput');
			if (fileInput.files.length === 0) {
				alert("⚠️ Lütfen önce fotoğrafınızı yükleyin!");
				fileInput.focus();
				return;
			}

			// 2. Arayüz Ayarları
			$(".action-btn").removeClass("active");
			$(btnElement).addClass("active");
			$("#resultCard").fadeIn();
			$("#loadingArea").show();
			$("#aiContentArea").hide();
			$("#debugErrorArea").hide();

			$("#simTitle").text(type === 'workout' ? "6 Ay Sonraki Tahmini Görünüm" : "2 Ay Sonraki Tahmini Görünüm");

			// 3. Veri Hazırlama
			var formData = new FormData();
			formData.append('adviceType', type);
			formData.append('userImage', fileInput.files[0]);

			// 4. İstek Gönderme
			$.ajax({
				url: '@Url.Action("GetAdvice", "AI")',
				type: 'POST',
				data: formData,
				processData: false,
				contentType: false,
				success: function (data) {
					$("#loadingArea").hide();
					$("#aiContentArea").fadeIn();

					if (data.success) {
						// Program içeriği
						$("#aiText").html(data.content);

						// Resim varsa göster
						if (data.generatedImage) {
							$("#generatedImage").attr("src", "data:image/jpeg;base64," + data.generatedImage).fadeIn();
							$("#imagePlaceholder").hide();
						} else {
							$("#generatedImage").hide();
							$("#imagePlaceholder").html('<p class="text-muted">Görsel oluşturulamadı</p>');
						}

						// Debug mesajı (test için)
						if (data.debugError) {
							$("#debugErrorArea").show();
							$("#debugErrorText").text(data.debugError);
						}
					} else {
						$("#aiText").html('<div class="alert alert-danger">' + data.message + '</div>');
					}
				},
				error: function () {
					$("#loadingArea").hide();
					$("#aiContentArea").show();
					$("#aiText").html('<div class="alert alert-danger">❌ Sunucu hatası. Lütfen tekrar deneyin.</div>');
				}
			});
		}

		function printDiv() {
			var printContents = document.getElementById("aiContentArea").innerHTML;
			var originalContents = document.body.innerHTML;
			document.body.innerHTML = printContents;
			window.print();
			document.body.innerHTML = originalContents;
			location.reload();
		}
	</script>
}
